<page-header title="'Create Edge stack'" breadcrumbs="[{label:'Edge Stacks', link:'edge.stacks'}, 'Create Edge stack']"> </page-header>

<div class="row">
  <div class="col-sm-12">
    <rd-widget>
      <rd-widget-body>
        <form class="form-horizontal" name="$ctrl.form">
          <!-- name-input -->
          <div class="form-group">
            <label for="stack_name" class="col-sm-1 control-label required text-left"> Name </label>
            <div class="col-sm-11">
              <input
                type="text"
                class="form-control"
                ng-model="$ctrl.formValues.Name"
                id="stack_name"
                name="nameField"
                ng-pattern="$ctrl.formValues.DeploymentType === $ctrl.EditorType.Compose ? STACK_NAME_VALIDATION_REGEX : ''"
                placeholder="e.g. mystack"
                auto-focus
                required
                data-cy="edgeStackCreate-nameInput"
              />
              <div class="help-block" ng-show="$ctrl.form.$invalid">
                <div class="small text-warning">
                  <div ng-messages="$ctrl.form.$error">
                    <p ng-message="required" class="vertical-center">
                      <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon>
                      <span>Name is required.</span>
                    </p>
                    <p ng-message="pattern" class="vertical-center">
                      <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon>
                      <span>This field must consist of lower case alphanumeric characters, '_' or '-' (e.g. 'my-name', or 'abc-123').</span>
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- !name-input -->

          <edge-groups-selector ng-if="$ctrl.formValues.Groups" value="$ctrl.formValues.Groups" on-change="($ctrl.onChangeGroups)"></edge-groups-selector>

          <p class="col-sm-12 vertical-center help-block small text-warning" ng-if="$ctrl.formValues.DeploymentType === undefined">
            <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon> There are no available deployment types when there is more than one type of environment in your edge group
            selection (e.g. Kubernetes and Docker environments). Please select edge groups that have environments of the same type.
          </p>

          <edge-stack-deployment-type-selector
            value="$ctrl.formValues.DeploymentType"
            has-docker-endpoint="$ctrl.hasType($ctrl.EnvironmentType.EdgeAgentOnDocker)"
            has-kube-endpoint="$ctrl.hasType($ctrl.EnvironmentType.EdgeAgentOnKubernetes)"
            on-change="($ctrl.onChangeDeploymentType)"
          ></edge-stack-deployment-type-selector>

          <edge-stacks-docker-compose-form
            ng-if="$ctrl.formValues.DeploymentType == $ctrl.EditorType.Compose"
            form-values="$ctrl.formValues"
            state="$ctrl.state"
            template="$ctrl.state.selectedTemplate"
            on-change-template="($ctrl.onChangeTemplate)"
          ></edge-stacks-docker-compose-form>

          <edge-stacks-kube-manifest-form
            ng-if="$ctrl.formValues.DeploymentType == $ctrl.EditorType.Kubernetes"
            form-values="$ctrl.formValues"
            state="$ctrl.state"
          ></edge-stacks-kube-manifest-form>

          <div ng-if="$ctrl.state.Method !== 'repository'">
            <div class="form-section-title"> Webhooks </div>
            <por-switch-field
              label="'Create an Edge stack webhook'"
              checked="$ctrl.formValues.webhookEnabled"
              on-change="($ctrl.onChangeWebhookState)"
              tooltip="'Create a webhook (or callback URI) to automate the update of this stack. Sending a POST request to this callback URI (without requiring any authentication) will pull the most up-to-date version of the associated image and re-deploy this stack.'"
              label-class="'col-sm-3 col-lg-2'"
            ></por-switch-field>

            <div ng-if="$ctrl.formValues.webhookEnabled" class="small flex items-center gap-1 text-xs">
              <pr-icon icon="'alert-circle'" mode="'warning'" class-name="'flex-none'"></pr-icon>
              <span class="text-muted">
                Sending environment variables to the webhook is updating the stack with the new values. New variables names will be added to the stack and existing variables will
                be updated.</span
              >
            </div>
          </div>

          <environment-variables-panel
            ng-if="$ctrl.formValues.DeploymentType == $ctrl.EditorType.Compose"
            values="$ctrl.formValues.envVars"
            on-change="($ctrl.onEnvVarChange)"
          ></environment-variables-panel>

          <private-registry-fieldset
            method="$ctrl.state.Method"
            value="$ctrl.registryID"
            registries="$ctrl.formValues.RegistryOptions"
            on-change="($ctrl.matchRegistry)"
            form-invalid="$ctrl.formIsInvalid()"
            error-message="$ctrl.errorMessage"
            on-select="($ctrl.selectedRegistry)"
            clear-registries="($ctrl.clearRegistries)"
          ></private-registry-fieldset>

          <div class="form-group">
            <div class="col-sm-12">
              <por-switch-field
                ng-if="$ctrl.formValues.DeploymentType == $ctrl.EditorType.Compose"
                checked="$ctrl.formValues.PrePullImage"
                name="'prePullImage'"
                label="'Pre-pull images'"
                tooltip="'When enabled, the image will be pre-pulled before deployment is started. This is useful in scenarios where the image download may be delayed or  intermittent and would subsequently cause the deployment to fail'"
                label-class="'col-sm-3 col-lg-2'"
                on-change="($ctrl.onChangePrePullImage)"
              ></por-switch-field>
            </div>
          </div>

          <div class="form-group">
            <div class="col-sm-12">
              <por-switch-field
                ng-if="$ctrl.formValues.DeploymentType == $ctrl.EditorType.Compose"
                checked="$ctrl.formValues.RetryDeploy"
                name="'retryDeploy'"
                label="'Retry deployment'"
                tooltip="'When enabled, this will allow the edge agent to retry deployment if failed to deploy initially'"
                label-class="'col-sm-3 col-lg-2'"
                on-change="($ctrl.onChangeRetryDeploy)"
              ></por-switch-field>
            </div>
          </div>

          <stagger-fieldset is-edit="$ctrl.state.isEdit" values="$ctrl.formValues.staggerConfig" on-change="($ctrl.onChangeStaggerConfig)"></stagger-fieldset>

          <!-- actions -->
          <div class="col-sm-12 form-section-title"> Actions </div>
          <div class="form-group">
            <div class="col-sm-12">
              <button
                type="button"
                class="btn btn-primary btn-sm"
                ng-disabled="
                  $ctrl.state.actionInProgress ||
                  $ctrl.formIsInvalid() ||
                  ($ctrl.formValues.RepositoryAuthentication && (!$ctrl.formValues.RepositoryPassword && $ctrl.formValues.RepositoryGitCredentialID===0)) ||
                  ($ctrl.formValues.RepositoryAuthentication && $ctrl.formValues.RepositoryPassword && $ctrl.formValues.SaveCredential && (!$ctrl.formValues.NewCredentialName || $ctrl.formValues.NewCredentialNameExist || $ctrl.formValues.NewCredentialNameInvalid)) ||
                  ($ctrl.formValues.SupportRelativePath && $ctrl.formValues.FilesystemPath.length === 0) ||
                  ($ctrl.formValues.SupportRelativePath && $ctrl.formValues.SupportPerDeviceConfigs && $ctrl.formValues.PerDeviceConfigsPath.length === 0)
                "
                ng-click="$ctrl.createStack()"
                button-spinner="$ctrl.state.actionInProgress"
                analytics-on
                analytics-event="edge-stack-creation"
                analytics-category="edge"
                analytics-properties="$ctrl.buildAnalyticsProperties()"
                data-cy="edgeStackCreate-createStackButton"
              >
                <span ng-hide="$ctrl.state.actionInProgress">Deploy the stack</span>
                <span ng-show="$ctrl.state.actionInProgress">Deployment in progress...</span>
              </button>
              <span class="text-danger" ng-if="$ctrl.state.formValidationError" style="margin-left: 5px">
                {{ $ctrl.state.formValidationError }}
              </span>
            </div>
          </div>
          <!-- !actions -->
        </form>
      </rd-widget-body>
    </rd-widget>
  </div>
</div>
