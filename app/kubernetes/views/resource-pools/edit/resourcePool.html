<page-header
  ng-if="ctrl.state.viewReady"
  title="'Namespace details'"
  breadcrumbs="[{ label:'Namespaces', link:'kubernetes.resourcePools' }, ctrl.pool.Namespace.Name]"
  reload="true"
></page-header>

<kubernetes-view-loading view-ready="ctrl.state.viewReady"></kubernetes-view-loading>

<div ng-if="ctrl.state.viewReady">
  <div class="row">
    <div class="col-sm-12">
      <rd-widget>
        <rd-widget-body classes="no-padding">
          <uib-tabset active="ctrl.state.activeTab" justified="true" type="pills">
            <uib-tab index="0" classes="btn-sm" select="ctrl.selectTab(0)">
              <uib-tab-heading class="vertical-center"> <pr-icon icon="'layers'"></pr-icon> Namespace </uib-tab-heading>
              <form class="form-horizontal" autocomplete="off" name="resourcePoolEditForm" style="padding: 20px; margin-top: 10px">
                <!-- name-input -->
                <div class="form-group">
                  <div class="col-sm-12">
                    <table class="table">
                      <tbody>
                        <tr>
                          <td>Name</td>
                          <td>
                            {{ ctrl.pool.Namespace.Name }}
                            <span class="label label-info image-tag label-margins" ng-if="ctrl.isSystem">system</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="col-sm-12 annotations mb-4 p-0">
                  <annotations
                    initial-annotations="ctrl.formValues.Annotations"
                    handle-update-annotations="ctrl.handleUpdateAnnotations"
                    errors="ctrl.state.annotationsErrors"
                    hide-form="!ctrl.canEdit"
                  ></annotations>
                </div>

                <!-- !name-input -->
                <div authorization="K8sResourcePoolDetailsW" ng-if="ctrl.isEditable" class="col-sm-12 form-section-title">Resource quota</div>
                <!-- quotas-switch -->
                <div authorization="K8sResourcePoolDetailsW" ng-if="ctrl.isEditable" class="form-group">
                  <div class="col-sm-12 small text-muted" ng-if="ctrl.state.resourceOverCommitEnabled">
                    <span class="vertical-center">
                      <pr-icon icon="'info'" mode="'primary'"></pr-icon>
                      A namespace is a logical abstraction of a Kubernetes cluster, to provide for more flexible management of resources. Best practice is to set a quota assignment
                      as this ensures greatest security/stability; alternatively, you can disable assigning a quota for unrestricted access (not recommended).
                    </span>
                  </div>
                  <div class="col-sm-12 small text-muted" ng-if="!ctrl.state.resourceOverCommitEnabled">
                    <span class="vertical-center">
                      <pr-icon icon="'info'" mode="'primary'"></pr-icon>
                      A namespace is a logical abstraction of a Kubernetes cluster, to provide for more flexible management of resources. Resource over-commit is disabled, please
                      assign a capped limit of resources to this namespace.
                    </span>
                  </div>
                  <div class="col-sm-12 pt-3">
                    <por-switch-field
                      data-cy="'k8sNamespaceEdit-resourceAssignmentToggle'"
                      label="'Resource assignment'"
                      label-class="'col-sm-3 col-lg-2'"
                      name="'k8s-resourcepool-resourcequota'"
                      checked="ctrl.formValues.HasQuota"
                      on-change="(ctrl.onToggleResourceQuota)"
                      disabled="!ctrl.state.resourceOverCommitEnabled"
                    ></por-switch-field>
                  </div>
                </div>
                <div class="form-group" ng-if="ctrl.formValues.HasQuota && ctrl.state.sliderMaxCpu <= 0 && ctrl.state.sliderMaxMemory <= 0">
                  <div class="col-sm-12 small text-warning">
                    <p class="vertical-center">
                      <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon>
                      Not enough resources available in the cluster to apply a resource reservation.
                    </p>
                  </div>
                </div>
                <div ng-if="ctrl.formValues.HasQuota && (ctrl.formValues.CpuLimit || ctrl.formValues.MemoryLimit)">
                  <kubernetes-resource-reservation
                    ng-if="ctrl.pool.Quota"
                    description="Resource reservation represents the total amount of resource assigned to all the applications deployed inside this namespace."
                    cpu-reservation="ctrl.state.resourceReservation.CPU"
                    memory-reservation="ctrl.state.resourceReservation.Memory"
                    cpu-limit="ctrl.formValues.CpuLimit"
                    memory-limit="ctrl.formValues.MemoryLimit"
                    display-usage="ctrl.state.useServerMetrics"
                    cpu-usage="ctrl.state.resourceUsage.CPU"
                    memory-usage="ctrl.state.resourceUsage.Memory"
                  >
                  </kubernetes-resource-reservation>
                </div>
                <!-- !quotas-switch -->
                <div authorization="K8sResourcePoolDetailsW" ng-if="ctrl.formValues.HasQuota && ctrl.isEditable">
                  <div class="col-sm-12 form-section-title"> Resource limits </div>
                  <div>
                    <div class="form-group" authorization="K8sResourcePoolDetailsW" ng-if="ctrl.formValues.HasQuota && ctrl.isEditable && !ctrl.isQuotaValid()">
                      <span class="col-sm-12 text-warning small">
                        <p class="vertical-center">
                          <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon>
                          At least a single limit must be set for the quota to be valid.
                        </p>
                      </span>
                    </div>
                    <!-- memory-limit-input -->
                    <div class="form-group flex">
                      <label for="memory-limit" class="col-sm-3 col-lg-2 control-label vertical-center text-left"> Memory limit (MB) </label>
                      <div class="col-sm-6">
                        <por-slider
                          min="ctrl.ResourceQuotaDefaults.MemoryLimit"
                          max="ctrl.state.sliderMaxMemory"
                          step="128"
                          ng-if="ctrl.state.sliderMaxMemory"
                          value="ctrl.formValues.MemoryLimit"
                          on-change="(ctrl.handleMemoryLimitChange)"
                          visible-tooltip="true"
                          data-cy="k8sNamespaceEdit-memoryLimitSlider"
                          disabled="ctrl.deploymentOptions.hideAddWithForm"
                        ></por-slider>
                      </div>
                      <div class="col-sm-2 vertical-center pt-6">
                        <input
                          name="memory_limit"
                          type="number"
                          min="{{ ctrl.ResourceQuotaDefaults.MemoryLimit }}"
                          max="{{ ctrl.state.sliderMaxMemory }}"
                          class="form-control"
                          ng-model="ctrl.formValues.MemoryLimit"
                          id="memory-limit"
                          data-cy="k8sNamespaceEdit-memoryLimitInput"
                          disable-deployment-option="form"
                          required
                        />
                      </div>
                    </div>
                    <div class="form-group" ng-show="resourcePoolEditForm.memory_limit.$invalid">
                      <div class="col-sm-3 col-lg-2"></div>
                      <div class="col-sm-8 small text-muted">
                        <div ng-messages="resourcePoolEditForm.pool_name.$error">
                          <p class="vertical-center">
                            <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon> Value must be between {{ ctrl.ResourceQuotaDefaults.MemoryLimit }} and
                            {{ ctrl.state.sliderMaxMemory }}.
                          </p>
                        </div>
                      </div>
                    </div>
                    <!-- !memory-limit-input -->
                    <!-- cpu-limit-input -->
                    <div class="form-group">
                      <label for="cpu-limit" class="col-sm-3 col-lg-2 control-label text-left" style="margin-top: 20px"> CPU limit </label>
                      <div class="col-sm-8">
                        <por-slider
                          min="ctrl.ResourceQuotaDefaults.CpuLimit"
                          max="ctrl.state.sliderMaxCpu"
                          step="0.1"
                          ng-if="ctrl.state.sliderMaxCpu"
                          value="ctrl.formValues.CpuLimit"
                          on-change="(ctrl.handleCpuLimitChange)"
                          data-cy="k8sNamespaceEdit-cpuLimitSlider"
                          visible-tooltip="true"
                          disabled="ctrl.deploymentOptions.hideAddWithForm"
                        ></por-slider>
                      </div>
                    </div>
                    <!-- !cpu-limit-input -->
                  </div>
                </div>
                <!-- #region LOADBALANCERS -->
                <div ng-if="ctrl.state.useLoadBalancer && ((ctrl.isEditable && ctrl.state.hasWriteAuthorization) || (ctrl.oldQuota && ctrl.oldQuota.LoadBalancers > 0))">
                  <div class="col-sm-12 form-section-title"> Load balancers </div>

                  <div authorization="K8sResourcePoolDetailsW" ng-if="ctrl.isEditable">
                    <div class="form-group">
                      <div class="col-sm-12 small text-muted">
                        <p class="vertical-center">
                          <pr-icon icon="'info'" mode="'primary'"></pr-icon>
                          You can set a quota on the amount of external load balancers that can be created inside this namespace. Set this quota to 0 to effectively disable the use
                          of load balancers in this namespace.
                        </p>
                      </div>

                      <div class="col-sm-12">
                        <por-switch-field
                          data-cy="'k8sNamespaceCreate-loadBalancerQuotaToggle'"
                          label="'Load Balancer quota'"
                          label-class="'col-sm-3 col-lg-2'"
                          name="'k8s-resourcepool-Lbquota'"
                          feature-id="ctrl.LBQuotaFeatureId"
                          checked="ctrl.formValues.UseLoadBalancersQuota"
                          on-change="(ctrl.onToggleLoadBalancersQuota)"
                          disabled="ctrl.deploymentOptions.hideAddWithForm"
                        ></por-switch-field>
                      </div>
                    </div>

                    <div class="form-group" ng-if="ctrl.formValues.UseLoadBalancersQuota">
                      <label for="pool_name" class="col-sm-2 control-label text-left">Max Load Balancers</label>
                      <div class="col-sm-3">
                        <input
                          type="number"
                          class="form-control"
                          name="max_load_balancers"
                          ng-model="ctrl.formValues.LoadBalancers"
                          min="0"
                          required
                          auto-focus
                          disable-deployment-option="form"
                        />
                      </div>
                    </div>
                    <div class="form-group" ng-show="resourcePoolEditForm.max_load_balancers.$invalid || ctrl.state.loadBalancersUsed > ctrl.formValues.LoadBalancers">
                      <div class="col-sm-12 small text-warning">
                        <div ng-messages="resourcePoolEditForm.max_load_balancers.$error">
                          <p class="vertical-center" ng-message="required">
                            <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon>
                            Max load balancers value is required.
                          </p>
                          <p class="vertical-center" ng-message="min">
                            <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon>
                            Max load balancers value must be a positive number.
                          </p>
                          <p class="vertical-center" ng-if="ctrl.state.loadBalancersUsed > ctrl.formValues.LoadBalancers && ctrl.formValues.LoadBalancers >= 0">
                            <pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon>
                            Max load balancers value must be greater than the existing number of load balancers inside this namespace.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="form-group" ng-if="ctrl.oldQuota && ctrl.oldQuota.LoadBalancers > 0">
                    <label for="cpu-usage" class="col-sm-3 col-lg-2 control-label text-left"> Load Balancers usage </label>
                    <div class="col-sm-9" style="margin-top: 4px">
                      <uib-progressbar
                        animate="false"
                        value="ctrl.state.loadBalancersUsage"
                        type="{{ ctrl.state.loadBalancersUsage | kubernetesUsageLevelInfo }}"
                      ></uib-progressbar>
                      <span> {{ ctrl.state.loadBalancersUsed }} / {{ ctrl.oldQuota.LoadBalancers }} - {{ ctrl.state.loadBalancersUsage }}% </span>
                    </div>
                  </div>
                </div>
                <!-- #endregion -->
                <div authorization="K8sResourcePoolDetailsW" ng-if="ctrl.isEditable && ctrl.state.ingressAvailabilityPerNamespace" hide-deployment-option="form">
                  <!-- #region INGRESSES -->
                  <div class="col-sm-12 form-section-title"> Networking </div>
                  <ingress-class-datatable
                    ng-if="ctrl.state.ingressAvailabilityPerNamespace"
                    on-change-controllers="(ctrl.onChangeIngressControllerAvailability)"
                    ingress-controllers="ctrl.ingressControllers"
                    initial-ingress-controllers="$ctrl.initialIngressControllers"
                    description="'Enable the ingress controllers that users can select when publishing applications in this namespace.'"
                    no-ingress-controller-label="'No ingress controllers found in the cluster. Go to the cluster setup view to configure and allow the use of ingress controllers in the cluster.'"
                    view="'namespace'"
                  ></ingress-class-datatable>

                  <!-- #endregion -->
                </div>
                <!-- #region REGISTRIES -->
                <div>
                  <div class="col-sm-12 form-section-title"> Registries </div>

                  <div class="form-group" ng-if="!ctrl.canEdit || ctrl.isSystem">
                    <label class="col-sm-3 col-lg-2 control-label text-left" style="padding-top: 0"> Selected registries </label>
                    <div class="col-sm-9 col-lg-4">
                      {{ ctrl.selectedRegistries ? ctrl.selectedRegistries : 'None' }}
                    </div>
                  </div>

                  <div authorization="K8sResourcePoolDetailsW" ng-if="!ctrl.isSystem">
                    <div class="form-group">
                      <div class="col-sm-12 small text-muted">
                        <p class="vertical-center">
                          <pr-icon icon="'info'" mode="'primary'"></pr-icon>
                          Define which registries can be used by users who have access to this namespace.
                        </p>
                      </div>
                    </div>
                    <div class="form-group">
                      <label class="col-sm-3 col-lg-2 control-label !pt-0 text-left" for="registries-selector"> Select registries </label>
                      <div class="col-sm-8 col-lg-9">
                        <span class="small text-muted" ng-if="!ctrl.registries.length && ctrl.isAdmin">
                          No registries available. Head over to the <a ui-sref="portainer.registries">registry view</a> to define a container registry.
                        </span>
                        <span class="small text-muted" ng-if="!ctrl.registries.length && !ctrl.isAdmin">
                          No registries available. Contact your administrator to create a container registry.
                        </span>
                        <create-namespace-registries-selector
                          input-id="'registries-selector'"
                          value="ctrl.formValues.Registries"
                          on-change="(ctrl.onRegistriesChange)"
                          options="ctrl.registries"
                        >
                        </create-namespace-registries-selector>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- #endregion -->

                <div authorization="K8sResourcePoolDetailsR" ng-if="ctrl.isEditable && ctrl.formValues.StorageClasses.length">
                  <div class="col-sm-12 form-section-title"> Storage </div>
                  <div authorization="K8sResourcePoolDetailsW" class="form-group">
                    <div class="col-sm-12 small text-muted">
                      <p class="vertical-center">
                        <pr-icon icon="'info'" mode="'primary'"></pr-icon>
                        Quotas can be set on each storage option to prevent users from exceeding a specific threshold when deploying applications. You can set a quota to 0 to
                        effectively prevent the usage of a specific storage option inside this namespace.
                      </p>
                    </div>
                  </div>

                  <div class="form-section-title text-muted col-sm-12" style="width: 100%" ng-repeat-start="sc in ctrl.formValues.StorageClasses">
                    <div class="vertical-center"> <pr-icon icon="'database'"></pr-icon> {{ sc.Name }} </div>
                    <hr />
                  </div>

                  <storage-class-switch value="sc.Selected" name="sc.Name" on-change="(ctrl.onToggleStorageQuota)" authorization="K8sResourcePoolDetailsW"></storage-class-switch>

                  <div ng-repeat-end ng-if="sc.Selected">
                    <div class="form-group" authorization="K8sResourcePoolDetailsW">
                      <div class="col-sm-12 pl-0">
                        <label class="control-label col-sm-3 col-lg-2 text-left"> Maximum usage </label>
                        <div class="col-sm-3">
                          <input
                            type="number"
                            class="form-control"
                            name="storage_class_size_{{ $index }}"
                            ng-model="sc.Size"
                            placeholder="20"
                            min="0"
                            ng-min="0"
                            required
                            ng-change="ctrl.computeStorageQuotaUsage(sc)"
                          />
                        </div>
                        <div class="col-sm-2 col-lg-2">
                          <select
                            class="form-control"
                            ng-model="sc.SizeUnit"
                            ng-options="unit for unit in ctrl.state.availableSizeUnits"
                            ng-change="ctrl.computeStorageQuotaUsage(sc)"
                          ></select>
                        </div>
                      </div>
                    </div>

                    <div class="form-group" ng-show="resourcePoolEditForm['storage_class_size_' + $index].$invalid">
                      <div class="col-sm-12 small text-muted">
                        <div ng-messages="resourcePoolEditForm['storage_class_size_' + $index].$error">
                          <p class="vertical-center" ng-message="required"><pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon> Size is required.</p>
                          <p class="vertical-center" ng-message="number"><pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon> Invalid number.</p>
                          <p class="vertical-center" ng-message="min"><pr-icon icon="'alert-triangle'" mode="'warning'"></pr-icon> This value must be greater than zero.</p>
                        </div>
                      </div>
                    </div>

                    <div class="form-group">
                      <label class="col-sm-2 control-label text-left"> Quota usage </label>
                      <div class="col-sm-10" style="margin-top: 4px">
                        <uib-progressbar animate="false" value="sc.Usage" type="{{ sc.Usage | kubernetesUsageLevelInfo }}"></uib-progressbar>
                        <span> {{ sc.Used.Size }} {{ sc.Used.SizeUnit }} / {{ sc.Size }} {{ sc.SizeUnit }} - {{ sc.Usage }}% </span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- summary -->
                <kubernetes-summary-view
                  ng-if="resourcePoolEditForm.$valid && !ctrl.isUpdateButtonDisabled()"
                  form-values="ctrl.formValues"
                  old-form-values="ctrl.savedFormValues"
                ></kubernetes-summary-view>
                <!-- !summary -->

                <!-- actions -->
                <div authorization="K8sResourcePoolDetailsW" class="col-sm-12 form-section-title"> Actions </div>
                <div authorization="K8sResourcePoolDetailsW" class="form-group">
                  <div class="col-sm-12">
                    <button
                      type="button"
                      ng-if="!ctrl.isSystem"
                      class="btn btn-primary btn-sm !ml-0 mr-1"
                      ng-disabled="!resourcePoolEditForm.$valid || ctrl.isUpdateButtonDisabled() || !ctrl.isAnnotationsValid()"
                      ng-click="ctrl.updateResourcePool()"
                      button-spinner="ctrl.state.actionInProgress"
                    >
                      <span ng-hide="ctrl.state.actionInProgress" data-cy="k8sNamespaceEdit-updateNamespaceButton">Update namespace</span>
                      <span ng-show="ctrl.state.actionInProgress">Update in progress...</span>
                    </button>
                    <button
                      ng-if="!ctrl.isDefaultNamespace"
                      type="button"
                      class="btn btn-light btn-sm !ml-0"
                      ng-click="ctrl.markUnmarkAsSystem()"
                      button-spinner="ctrl.state.actionInProgress"
                      data-cy="k8sNamespaceEdit-markSystem"
                      hide-deployment-option="form"
                    >
                      <span ng-if="ctrl.isSystem">Unmark as system</span>
                      <span ng-if="!ctrl.isSystem">Mark as system</span>
                    </button>
                  </div>
                </div>
                <!-- !actions -->
              </form>
            </uib-tab>
            <uib-tab index="1" classes="btn-sm" select="ctrl.selectTab(1)">
              <uib-tab-heading class="vertical-center">
                <pr-icon icon="'history'"></pr-icon> Events
                <div ng-if="ctrl.hasEventWarnings()">
                  <pr-icon icon="'alert-triangle'" mode="'warning'" class-name="'mr-0.5'"></pr-icon>
                  {{ ctrl.state.eventWarningCount }} warning(s)
                </div>
              </uib-tab-heading>
              <kubernetes-events-datatable
                title-text="Events"
                dataset="ctrl.events"
                table-key="kubernetes.resourcepool.events"
                order-by="Date"
                reverse-order="true"
                loading="ctrl.state.eventsLoading"
                refresh-callback="ctrl.getEvents"
              ></kubernetes-events-datatable>
            </uib-tab>
            <uib-tab index="2" ng-if="ctrl.pool.Yaml" select="ctrl.showEditor()" classes="btn-sm">
              <uib-tab-heading class="vertical-center"><pr-icon icon="'code'"></pr-icon> YAML </uib-tab-heading>
              <div class="px-5" ng-if="ctrl.state.showEditorTab">
                <kube-yaml-inspector identifier="'namespace-yaml'" data="ctrl.pool.Yaml" system="ctrl.isSystem" authorised="ctrl.state.hasWriteAuthorization" hide-message="true" />
              </div>
            </uib-tab>
          </uib-tabset>
        </rd-widget-body>
      </rd-widget>
    </div>
  </div>

  <div class="row" ng-if="ctrl.applications && ctrl.applications.length > 0">
    <div class="col-sm-12">
      <kubernetes-resource-pool-applications-datatable
        dataset="ctrl.applications"
        table-key="kubernetes.resourcepool.applications"
        order-by="Name"
        refresh-callback="ctrl.getApplications"
        loading="ctrl.state.applicationsLoading"
        title-text="Applications running in this namespace"
        title-icon="code"
      >
      </kubernetes-resource-pool-applications-datatable>
    </div>
  </div>

  <div class="row" ng-if="ctrl.ingresses && ctrl.ingresses.length > 0">
    <div class="col-sm-12">
      <kubernetes-resource-pool-ingresses-datatable
        dataset="ctrl.ingresses"
        table-key="kubernetes.resourcepool.ingresses"
        order-by="Name"
        refresh-callback="ctrl.getIngresses"
        loading="ctrl.state.ingressesLoading"
        title-text="Ingress routes and applications"
        title-icon="svg-route"
      >
      </kubernetes-resource-pool-ingresses-datatable>
    </div>
  </div>
</div>
